pipeline:
  npm_install:
    image: node:9.11.1
    commands:
      - env
      - yarn
      - yarn test
      - yarn build
  publish:
    image: plugins/docker
    username: josmo
    secrets: [ docker_password ]
    repo: peloton/aws-pricing-api
    auto_tag: true
    file: Dockerfile
    when:
      event: [ push, tag ]

  deploy:
    image: peloton/drone-k8s-deployment
    pull: true
    url: https://rancher.pelo.tech/k8s/clusters/c-ss4wc
    secrets: [ kubernetes_token ]
    namespaces: classis
    deployment_names: aws-pricing-api
    docker_image: "peloton/aws-pricing-api:${DRONE_TAG}"
    container_names: aws-pricing-api
    when:
      event: [ tag ]
      branch: [ master ]
